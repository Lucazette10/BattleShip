@page "/game"
@inject HttpClient HttpClient

@using System.Text.Json;

<h3>BattleShip Game : @Id</h3>
<div class="container">
    <div class="playerGrid">
        <h4>Your Grid</h4>
        <div class="playerTable">
            <table>
                <tr>
                    <td></td> <!-- Empty cell for the top-left corner -->
                    @for (char c = 'A'; c <= 'J'; c++)
                    {
                        <td style="text-align: center">@c</td>
                    }
                </tr>
                @for (int row = 0; row < 10; row++) {
                    <tr>
                        <td>@(row + 1)</td> <!-- Row number -->
                        @for (int col = 0; col < 10; col++) {
                            var style = "border: 1px solid black; width: 20px; height: 20px; text-align: center;";
                            if (playerGrid[row, col] == "S") {
                                style += "background-color: rgba(128, 128, 128, 0.2);";
                            } else if (playerGrid[row, col] == "X") {
                                style += "background-color: rgba(255, 0, 0, 0.2);"; 
                            } else {
                                style += "background-color: rgba(0, 0, 255, 0.2);"; 
                            }
                            <td style="@style">
                                @playerGrid[row, col]
                            </td>
                        }
                    </tr>
                }
            </table>
        </div>
    </div>

    <div class="leaderboard">
        <h4>Historique des coups joués</h4>
        <ul>
            @foreach(var move in playerMoves) {
                <li>@move</li>
            }
        </ul>
    </div>

    <div class="computerGrid">
        <h4>Opponent's Grid</h4>
        <table>
            <tr>
                <td></td> <!-- Empty cell for the top-left corner -->
                @for (char c = 'A'; c <= 'J'; c++)
                {
                    <td style="text-align: center">@c</td>
                }
            </tr>
            @for (int row = 0; row < 10; row++) {
                var currentRow = row;
                <tr>
                    <td>@(row + 1)</td> <!-- Row number -->
                    @for (int col = 0; col < 10; col++) {
                        var currentCol = col;
                        var style = "border: 1px solid black; width: 20px; height: 20px; text-align: center;";
                        if (opponentGrid[row, col] == "S") {
                            style += "background-color: rgba(128, 128, 128, 0.2);";
                        } else if (opponentGrid[row, col] == "X") {
                            style += "background-color: rgba(255, 0, 0, 0.2);"; 
                        } else {
                            style += "background-color: rgba(0, 0, 255, 0.2);"; 
                        }
                        <td @onclick="() => HandleClick(currentRow, currentCol)" style="@style">
                            @opponentGrid[row, col]
                        </td>
                    }
                </tr>
            }
        </table>
    </div>
</div>

@code {
    //[Parameter] public string Id { get; set; }
    
    private Models.Game game;
    private List<Models.Ship> playerShips;
    private string Id;

    private string[,] opponentGrid = new string[10, 10];
    private string[,] playerGrid = new string[10, 10];
    private List<string> playerMoves = new List<string>();

    protected override async Task OnInitializedAsync()
    {
        game = await StartGame();
        playerShips = game.playerShips;
        Id = game.gameId;

        foreach (var ship in playerShips)
        {
            foreach (var coordinate in ship.coordinates)
            {
                playerGrid[coordinate.Row, coordinate.Col] = "S";
            }
        }

    }
    
    
    private async Task HandleClick(int row, int col)
    {
        Console.WriteLine($"Clicked on {row}, {col}");
        Console.WriteLine($"Sending attack to {Id}");

        if (opponentGrid[row, col] == "X" || opponentGrid[row, col] == "O")
        {
            Console.WriteLine("You already attacked this cell!");
            return;
        }

        var coordinate = new { Row = row, Col = col };
        var json = JsonSerializer.Serialize(coordinate);
        var data = new StringContent(json, System.Text.Encoding.UTF8, "application/json");

        var response = await HttpClient.PostAsync($"/attack/{Id}", data);
        Console.WriteLine($"response : {response}");

        if (response.IsSuccessStatusCode)
        {
            // Update the UI
            var attackResponse = await response.Content.ReadFromJsonAsync<Models.AttackResponse>();
            Console.WriteLine($"attack response : {attackResponse.ComputerAttack.Col}, {attackResponse.ComputerAttack.Row}");

            if(attackResponse.ComputerWon == true){
                Console.WriteLine("L'ordinateur a gagné !");
            }
            if(attackResponse.PlayerWon == true){
                Console.WriteLine("Tu as gagné !");
            }

            if(playerGrid[attackResponse.ComputerAttack.Row, attackResponse.ComputerAttack.Col] == "S") {
                Console.WriteLine("Computer hit your ship!");
                playerGrid[attackResponse.ComputerAttack.Row, attackResponse.ComputerAttack.Col] = "X";
            }
            else if(playerGrid[attackResponse.ComputerAttack.Row, attackResponse.ComputerAttack.Col] == null) {
                Console.WriteLine("Computer missed your ship!");
                playerGrid[attackResponse.ComputerAttack.Row, attackResponse.ComputerAttack.Col] = "O";
            }
            else {
                Console.WriteLine("Computer already attacked this cell!");
            }

            if(attackResponse.PlayerAttackResult) {
                Console.WriteLine("You hit the ship!");
                playerMoves.Add($"You hit the ship at ({row}, {col})!");
                opponentGrid[row, col] = "X";
            }
            else if(!attackResponse.PlayerAttackResult) {
                Console.WriteLine("You missed the ship!");
                playerMoves.Add($"You missed the ship at ({row}, {col})!");
                opponentGrid[row, col] = "O";
            }
            else {
                Console.WriteLine("You already attacked this cell !");
                playerMoves.Add($"You already attacked this cell !");
            }

            StateHasChanged();
            
            
        }
        else
        {
            // Handle the error
        }
    }

    private async Task<Models.Game> StartGame(){

        var response = await HttpClient.GetAsync("/start");

        if (response.IsSuccessStatusCode)
        {
            if(response.Content.Headers.ContentType.MediaType == "application/json") {
                game = await response.Content.ReadFromJsonAsync<Models.Game>(); 
                return game;
            }
            else {
                Console.WriteLine("Error: Response is not in JSON format");
            }
        }
        else
        {
            var errorResponse = await response.Content.ReadAsStringAsync();
            Console.WriteLine($"Error: {errorResponse}");
        }
        return null;
    }
}